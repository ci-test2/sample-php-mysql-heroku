language: php

php: 
  - 5.6

env:
  global:
    - APP_NAME=citest2-phpmysqlheroku-beta
    - CLEARDB_DATABASE_URL=mysql://shippable@127.0.0.1:3306/test?reconnect=true
    - secure: h1/NpPiB+nNwZ6A4ZzxSJZPGcHQM65LO+iXq5mOCS8HxDVaMVHyu9IjbQBlUvr1il0TaQFUEI8cO6JjwHtnx07brwtnX1HAakhUyYGqTfbuZOzEoM2Yb4wV1uNjQhQFLc3SZFElnfRZf6TN6i3W3fuD+CF7z/PNNaiuDQzYv25t5wrq+T6ZxPXRgmkkc951SlyWpKXe0H6N2aMH3Vr8LbeXuWNzBea8dFFAOVD6DQj+63qBK/gTcskDDEXQ/HcTJG3iBummr2MtrLOZuqt9cN5zT1ljwAfTsNetruuPyda7E4thnXyXhBWnAKdhTuICTnWtszElbqFMKAcFPIHvSvw== 
   # - secure: DxrUltn21LffQAjZ5tVMeUoRu/e6vCjBcRk4qfKqWeN4pS9KmXGHuzmXUJwSExDvp7k9mwpPTpmK5ZySsmuVfsUhpJha7QtLkr+cuKAiJbzto+XnJ5lXgBdc8aR0zWMYtuNe0FI5ITikU/bPf51oVhwry/HU3TsQDatiOCZ02MrTyYIYu/d/3VZvNX6jjkZVHbYMHG0IscGmU4QBLnLXMm2A0wrFdXM1r43MUBWM4Nfe1Bwa8vq01hK3IOOWFIGi9d8QYKBjISbf8B6eNvvOV9lEbFludgNHO6MKAYl0Y2RofNyIKMzBBLGB1CGGwzzgJpkMA+ZyaKN1weYFt8iQKQ== 
    
before_install:
  - which heroku || wget -qO- https://toolbelt.heroku.com/install-ubuntu.sh | sh
  - . $HOME/.rvm/scripts/rvm && rvm use ruby-2.0.0-p598 --default && ruby --version

before_script: 
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
  - mysql -e 'create database if not exists test;'

script:
  - phpunit --log-junit shippable/testresults/junit.xml --coverage-xml shippable/codecoverage test.php

after_success:
  - test -f ~/.ssh/id_rsa.heroku || ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.heroku && heroku keys:add ~/.ssh/id_rsa.heroku
  - git remote -v | grep ^heroku || heroku git:remote --ssh-git --app $APP_NAME
  - git push -f heroku $BRANCH:master
